{% extends "base.html" %}

{% block content %}

<!-- main content -->
<main class="container">
    <div class="content">

        <div class="row" style="margin-top: 32px;">

            <h1 style="text-align: center;">{{ analysis_name }}</h1>
            <h3 style="text-align: center; color: #888888">{{ network.name }}</h3>
            <!-- <h5 style="color: #888888">{{ pretty_analysis_type }}</h5> -->

        </div>

        <div class="row" style="margin-top: 32px;">
            <!-- map -->
            <div class="col-sm-12">
                <!-- XXX: hacky hardocded -->
                <div id="map_id" style="height: 800px; width=100%; border-radius: 8px;"></div>

                <p id="info_text" style="margin-top: 8px; text-align: center; font-weight: bold;">Click on a pipe to see affected nodes.</p>

            </div>

            <p style="text-align: center;"><a href="download"><button class="btn btn-warning btn-sm"><i class="fas fa-download"></i> download</button></a> or <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#exampleModal"><i class="fas fa-palette"></i> change style</button></p>
        </div>

    </div>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    ...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>

</main>

<script>
    function make_color_ramp(color1, color2, nparts) {
        const [r0, g0, b0] = [0, 2, 4].map(i => parseInt(color1.slice(i, i + 2), 16));
        const [r1, g1, b1] = [0, 2, 4].map(i => parseInt(color2.slice(i, i + 2), 16));

        const r_step = (r1 - r0) / (nparts - 1);
        const g_step = (g1 - g0) / (nparts - 1);
        const b_step = (b1 - b0) / (nparts - 1);

        const colors = [];

        for (let i = 0; i < nparts; i++) {
            const r = Math.round(r0 + i * r_step);
            const g = Math.round(g0 + i * g_step);
            const b = Math.round(b0 + i * b_step);

            const hexString = `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;

            colors.push(hexString);
        }

        return colors;
    }

    function getColor(colors, number_map, n) {
        const nparts = colors.length;
        const idx = number_map[n];
        const factor = nparts / Object.keys(number_map).length;
        color = colors[Math.floor(idx * factor)];
        return color;
    }

    var defaultLatLng = new L.LatLng(47.263, 11.404)

    var url = 'https://{s}.wien.gv.at/basemap/bmaporthofoto30cm/normal/google3857/{z}/{y}/{x}.jpeg',
        attrib = 'Datenquelle: <a href="https://basemap.at">basemap.at</a>',
        tilelayer = L.tileLayer(url, { maxZoom: 22, attribution: attrib, subdomains: ['maps1', 'maps2', 'maps3', 'maps4']}),

    map = new L.Map('map_id', { center: defaultLatLng, zoom: 14 });
    drawnItems = L.featureGroup().addTo(map);

    tilelayer.addTo(map);

    let color_list = make_color_ramp('00ff00', 'ff0000', 50);
    console.log(color_list);

    var links_geojson = {{ links_geojson|safe }};
    var nodes_geojson = {{ nodes_geojson|safe }};

    const junctionsImpactedArray = [];

    for (const feature of links_geojson.features) {
      if (feature.properties && feature.properties.junctions_impacted) {
        junctionsImpactedArray.push(feature.properties.junctions_impacted.length);
      }
    }

    const junctionsImpactedArrayUnique = [...new Set(junctionsImpactedArray)].sort((a, b) => a - b);

    var numberMap = {};

    for (let i = 0; i < junctionsImpactedArrayUnique.length; i++) {
        numberMap[junctionsImpactedArrayUnique[i]] = i;
    }

    let nodes = L.geoJson(nodes_geojson, {
        pointToLayer: function (feature, latlng) {
            let node_type = feature.properties.type;
            return L.circleMarker(latlng, {
                opacity: 0.0,
                radius: 2,
                fillColor: '#000088',
                fillOpacity: 0.5,
            });
        },
    });

    var atype = "{{ analysis_type }}";
    console.log(atype);

    let links = L.geoJson(links_geojson, {
        style: function(feature) {
            return {color: getColor(color_list, numberMap, feature.properties.junctions_impacted.length), weight: 2}
        },
    });

    let i = 0;
    links.eachLayer(function(){ i += 1; });
    console.log('Map has', i, 'layers.');

    links.on('click', function(e) {
        //console.log(e);

        var properties = e.layer.feature.properties;
        console.log(properties);

        // get the point ids associated with the line
        var pointIds = properties.junctions_impacted;
        console.log(pointIds)

        var n = 0;

        const infoTextElement = document.getElementById("info_text");
        infoTextElement.textContent = 'Failure of pipe ' + properties.id + ' impacts ' + properties.junctions_impacted.length + ' node(s).'

        // iterate over the point layer and change the color of the associated points
        nodes.eachLayer(function (layer) {
            if (pointIds.includes(layer.feature.properties.id)) {
                layer.setStyle({
                    opacity: 0.0,
                    radius: 5,
                    fillColor: 'red',
                    fillOpacity: 1.0,
                });
                n += 1;
            }
            else {
                layer.setStyle({
                    opacity: 0.0,
                    radius: 2,
                    fillColor: '#000088',
                    fillOpacity: 0.5,
                });
            }
        });

        console.log(n);
    });

    drawnItems.addLayer(links);
    drawnItems.addLayer(nodes);

    map.fitBounds(drawnItems.getBounds());

</script>

{% endblock %}
